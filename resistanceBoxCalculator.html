<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resistance Box Calibration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            margin: 0 auto;
        }

        .page-title {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
        }

        .input-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            height: 100%;
            transition: all 0.3s ease;
        }

        .input-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }

        .input-card label {
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-card label i {
            font-size: 1.2rem;
        }

        .calibration-icon {
            color: #fd7e14;
        }

        .target-icon {
            color: #dc3545;
        }

        textarea {
            resize: vertical;
            height: 280px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.8rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .btn-calculate:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .output-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .table {
            margin-bottom: 0;
            border-radius: 10px;
            overflow: hidden;
        }

        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .table thead th {
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f1f3f5;
            transform: scale(1.01);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }

        footer {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #667eea;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="main-container">
            <h1 class="page-title">
                <i class="bi bi-calculator-fill"></i>
                Resistance Box Best Match Finder
            </h1>

            <!-- Input Section for Calibration and Target Values -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="input-card">
                        <label for="calibrationInput" class="form-label">
                            <i class="bi bi-lightning-charge-fill calibration-icon"></i>
                            <strong>Paste Calibration Data (Î©)</strong>
                        </label>
                        <textarea class="form-control" id="calibrationInput" placeholder="Example (Virtual & Actual - tab separated):
100    100.0774
90     90.2707
80     80.4845
70     70.5896"></textarea>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="input-card">
                        <label for="targetInput" class="form-label">
                            <i class="bi bi-bullseye target-icon"></i>
                            <strong>Paste Target Actual Ohm Values</strong>
                        </label>
                        <textarea class="form-control" id="targetInput" placeholder="Example (one per line):
100
104.8764
109.73
114.5749
"></textarea>
                    </div>
                </div>
            </div>

            <!-- Button to start the calculation -->
            <div class="text-center mb-4">
                <button class="btn btn-primary btn-calculate" onclick="calculate()">
                    <i class="bi bi-search"></i> Find Best Matches
                </button>
            </div>

            <!-- Output div -->
            <div id="output"></div>
        </div>

        <footer class="text-center">
            <p class="mb-2 text-muted">
                <i class="bi bi-code-slash"></i> Developed by <strong>Mohamed Badr</strong>
            </p>
            <div class="d-flex justify-content-center gap-4">
                <a href="https://github.com/Mohamed-Badr-Saad" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> GitHub
                </a>
                <a href="https://www.linkedin.com/in/mohamed-badr-95283b278/" target="_blank"
                    class="text-decoration-none">
                    <i class="bi bi-linkedin"></i> LinkedIn
                </a>
            </div>
        </footer>
    </div>

    <script>
        /* Parses the calibration input text into an array of objects with virtual and actual values*/
        function parseCalibration(input) {
            return input.trim().split('\n').map(line => {
                const [virtual, actual] = line.trim().split(/\s+/).map(Number);
                return { virtual, actual };
            });
        }

        /* Groups the parsed calibration data into 5 predefined ranges (G1 to G5)*/
        function groupByRanges(data) {
            return {
                G1: data.filter(d => d.virtual >= 0 && d.virtual <= 0.09),
                G2: data.filter(d => d.virtual >= 0.1 && d.virtual <= 0.9),
                G3: data.filter(d => d.virtual >= 1 && d.virtual <= 9),
                G4: data.filter(d => d.virtual >= 10 && d.virtual <= 90 && d.virtual % 10 === 0),
                G5: data.filter(d => d.virtual >= 100 && d.virtual <= 900 && d.virtual % 100 === 0)
            };
        }

        /* Finds the best combination of values from the groups to match a target actual resistance*/
        function findBestCombo(groups, target) {
            let best = null;
            let minError = Infinity;

            // Extract group arrays
            const G1 = groups.G1, G2 = groups.G2, G3 = groups.G3, G4 = groups.G4, G5 = groups.G5;
            const groupLists = [G1, G2, G3, G4, G5];

            // Use bitmasks to try all combinations of 1-5 groups (Try every non-empty combination of groups using bitmasking (from 00001 to 11111))
            for (let mask = 1; mask < (1 << 5); mask++) {
                const activeGroups = [];
                /* Include only groups where the corresponding bit is set*/
                for (let i = 0; i < 5; i++) {
                    if (mask & (1 << i)) {
                        activeGroups.push(groupLists[i]);
                    }
                }

                /* Recursively build all combinations of one item from each active group*/
                const recurse = (idx, sum, virtuals, actuals) => {
                    // BASE CASE: We've selected one item from each active group
                    if (idx === activeGroups.length) {
                        const error = Math.abs(sum - target);
                        // Update the best combination if this one is closer
                        if (error < minError) {
                            minError = error;
                            best = {
                                actualSum: sum,
                                virtuals,
                                error
                            };
                        }
                        return;
                    }

                    // Try each item in the current group
                    for (const item of activeGroups[idx]) {
                        recurse(idx + 1,  // move to next group
                            sum + item.actual, // add actual resistance
                            [...virtuals, item.virtual],// add to virtual list
                            actuals);
                    }
                };

                recurse(0, 0, [], []);
            }

            return best;
        }

        // Main function triggered by button click
        function calculate() {
            const calibrationText = document.getElementById('calibrationInput').value;
            const targetText = document.getElementById('targetInput').value;

            // Parse inputs
            const calibrationData = parseCalibration(calibrationText);
            const targets = targetText.trim().split('\n').map(Number);
            const groups = groupByRanges(calibrationData);
            const output = document.getElementById('output');
            output.innerHTML = '';// Clear previous output

            // Create output section wrapper
            const outputSection = document.createElement('div');
            outputSection.className = 'output-section';

            // Create results table
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-responsive';

            const table = document.createElement('table');
            table.className = 'table table-hover table-bordered align-middle';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th scope="col"><i class="bi bi-bullseye"></i> Target Actual Ohm</th>
                        <th scope="col"><i class="bi bi-check-circle"></i> Best Actual Sum</th>
                        <th scope="col"><i class="bi bi-list-ul"></i> Virtual Ohms Used</th>
                        <th scope="col"><i class="bi bi-exclamation-triangle"></i> Error</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            // For each target value, compute the best match
            for (const target of targets) {
                const best = findBestCombo(groups, target);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${target}</td>
                    <td>${best.actualSum.toFixed(6)}</td>
                    <td>${best.virtuals.join(' + ')}</td>
                    <td>${best.error.toFixed(6)}</td>
                `;
                table.querySelector('tbody').appendChild(row);
            }

            tableWrapper.appendChild(table);
            outputSection.appendChild(tableWrapper);
            output.appendChild(outputSection);
        }
    </script>

</body>

</html>
